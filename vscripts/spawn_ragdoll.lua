local agents = {
    -- BALKAN
    "characters/models/tm_balkan/tm_balkan_variantf.vmdl",
    "characters/models/tm_balkan/tm_balkan_variantg.vmdl",
    "characters/models/tm_balkan/tm_balkan_varianth.vmdl",
    "characters/models/tm_balkan/tm_balkan_varianti.vmdl",
    "characters/models/tm_balkan/tm_balkan_variantj.vmdl",
    "characters/models/tm_balkan/tm_balkan_variantk.vmdl",
    "characters/models/tm_balkan/tm_balkan_variantl.vmdl",

    -- JUMPSUIT
    "characters/models/tm_jumpsuit/tm_jumpsuit_varianta.vmdl",
    "characters/models/tm_jumpsuit/tm_jumpsuit_variantb.vmdl",
    "characters/models/tm_jumpsuit/tm_jumpsuit_variantc.vmdl",

    -- JUNGLERAIDER
    "characters/models/tm_jungle_raider/tm_jungle_raider_varianta.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variantb.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variantb2.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variantc.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variantd.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variante.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variantf.vmdl",
    "characters/models/tm_jungle_raider/tm_jungle_raider_variantf2.vmdl",

    -- LEET
    "characters/models/tm_leet/tm_leet_varianta.vmdl",
    "characters/models/tm_leet/tm_leet_variantb.vmdl",
    "characters/models/tm_leet/tm_leet_variantc.vmdl",
    "characters/models/tm_leet/tm_leet_variantd.vmdl",
    "characters/models/tm_leet/tm_leet_variante.vmdl",
    "characters/models/tm_leet/tm_leet_variantf.vmdl",
    "characters/models/tm_leet/tm_leet_variantg.vmdl",
    "characters/models/tm_leet/tm_leet_varianth.vmdl",
    "characters/models/tm_leet/tm_leet_varianti.vmdl",
    "characters/models/tm_leet/tm_leet_variantj.vmdl",
    "characters/models/tm_leet/tm_leet_variantk.vmdl",


    -- PHOENIX
    "characters/models/tm_phoenix/tm_phoenix.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_varianta.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_variantb.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_variantc.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_variantd.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_variantf.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_variantg.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_varianth.vmdl",
    "characters/models/tm_phoenix/tm_phoenix_varianti.vmdl",
    
    -- PHOENIX HEAVY
    "characters/models/tm_phoenix_heavy/tm_phoenix_heavy.vmdl",

    -- PROFESSIONAL
    "characters/models/tm_professional/tm_professional_varf.vmdl",
    "characters/models/tm_professional/tm_professional_varf1.vmdl",
    "characters/models/tm_professional/tm_professional_varf2.vmdl",
    "characters/models/tm_professional/tm_professional_varf3.vmdl",
    "characters/models/tm_professional/tm_professional_varf4.vmdl",
    "characters/models/tm_professional/tm_professional_varf5.vmdl",
    "characters/models/tm_professional/tm_professional_varg.vmdl",
    "characters/models/tm_professional/tm_professional_varh.vmdl",
    "characters/models/tm_professional/tm_professional_vari.vmdl",
    "characters/models/tm_professional/tm_professional_varj.vmdl",
    -- SWAT
    "characters/models/ctm_swat/ctm_swat_variante.vmdl",
    "characters/models/ctm_swat/ctm_swat_variantf.vmdl",
    "characters/models/ctm_swat/ctm_swat_varianth.vmdl",
    "characters/models/ctm_swat/ctm_swat_varianti.vmdl",
    "characters/models/ctm_swat/ctm_swat_variantj.vmdl",
    "characters/models/ctm_swat/ctm_swat_variantk.vmdl",
    -- ST6
    "characters/models/ctm_st6/ctm_st6_variante.vmdl",
    "characters/models/ctm_st6/ctm_st6_variantg.vmdl",
    "characters/models/ctm_st6/ctm_st6_varianti.vmdl",
    "characters/models/ctm_st6/ctm_st6_variantj.vmdl",
    "characters/models/ctm_st6/ctm_st6_variantk.vmdl",
    "characters/models/ctm_st6/ctm_st6_variantl.vmdl",
    "characters/models/ctm_st6/ctm_st6_variantm.vmdl",
    "characters/models/ctm_st6/ctm_st6_variantn.vmdl",
    -- SAS
    "characters/models/ctm_sas/ctm_sas.vmdl",
    "characters/models/ctm_sas/ctm_sas_variantf.vmdl",
    "characters/models/ctm_sas/ctm_sas_variantg.vmdl",
    --CTM_HEAVY
    "characters/models/ctm_heavy/ctm_heavy.vmdl",
    --GENDARMERIE
    "characters/models/ctm_gendarmerie/ctm_gendarmerie_varianta.vmdl",
    "characters/models/ctm_gendarmerie/ctm_gendarmerie_variantb.vmdl",
    "characters/models/ctm_gendarmerie/ctm_gendarmerie_variantc.vmdl",
    "characters/models/ctm_gendarmerie/ctm_gendarmerie_variantd.vmdl",
    "characters/models/ctm_gendarmerie/ctm_gendarmerie_variante.vmdl",
    
    --FBI
    "characters/models/ctm_fbi/ctm_fbi.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_varianta.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_variantb.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_variantc.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_variantd.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_variante.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_variantf.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_variantg.vmdl",
    "characters/models/ctm_fbi/ctm_fbi_varianth.vmdl",
    
    --DIVER
    "characters/models/ctm_diver/ctm_diver_varianta.vmdl",
    "characters/models/ctm_diver/ctm_diver_variantb.vmdl",
    "characters/models/ctm_diver/ctm_diver_variantc.vmdl",
}
-- This script will check every 5 seconds and reapply the script if a player is active


print("Starting Spawn Ragdoll Script")
thisEntity:SetThink(function() 

    GetAllPlayers()

    return 5
end,"ReapplyWeapons",0)

function GetAllPlayers()
    local allPlayers = Entities:FindAllByClassname("player")
    for k,v in pairs(allPlayers) do
        ReInitPlayer(v)
    end
end

function SpawnRagdoll(player)
    local playerController = player:GetController()
    local pawn = playerController:GetPawn()
    local start = pawn:EyePosition()
    local forward = AnglesToVector(pawn:EyeAngles())

    local trRag = {
        startpos = start,
        endpos = start + forward * 4096,
    }
    TraceLine(trRag)
    local pos = trRag.pos -forward * 64
    pos = pos + Vector(0,0,32)

    local model = agents[RandomInt(1,#agents)]


    local rag = SpawnEntityFromTableSynchronous("prop_ragdoll",{
        model = model,
        origin = pos,
    })
    -- ScriptPrintMessageCenterAll(UniqueString("Spawned Ragdoll"))
    ScriptPrintMessageCenterAll(UniqueString(model))

end
function ExpTrace(player,impulse,reverse)
    impulse = impulse or 1200
    local playerController = player:GetController()
    local pawn = playerController:GetPawn()
    local start = pawn:EyePosition()
    local forward = AnglesToVector(pawn:EyeAngles())
    local trRag = {
        startpos = start,
        endpos = start + forward * 4096,
    }
    TraceLine(trRag)
    
    local pos = trRag.pos

    --SEND Ragdolls FLYING
    local ragdollsNear = Entities:FindAllByClassnameWithin("prop_ragdoll",pos,256)

    for k,v in pairs(ragdollsNear) do
        local vec = ((v:GetAbsOrigin() + Vector(0,0,128))-pos):Normalized()
        vec = vec
        v:ApplyLocalAngularVelocityImpulse(Vector(RandomFloat(-360,360),RandomFloat(-360,360),RandomFloat(-360,360)))
        v:ApplyAbsVelocityImpulse(vec*600)
    end

    if not reverse then
        player:ApplyAbsVelocityImpulse(forward*impulse)
    else
        player:ApplyAbsVelocityImpulse(-forward*impulse)

    end

end


function ReInitPlayer(v)
    local player = v
    local children = player:GetChildren()
        for k,c in pairs(children) do
            if c:GetClassname() == "weapon_knife" then

                player.knife = c
                player:SetThink(function() 
                    --** Gets player again if they're killed
                    if player:GetHealth() == 100 and not IsValidEntity(player.knife) then
                        ReInitPlayer(player)
                    else
                    
                        if IsValidEntity(player.knife) then
                            
                            local param = player.knife:GetGraphParameter("weapon_fire_primary_autoclear")
                            if param == true then
                                
                                if not player.knife.spawned then
                                    SpawnRagdoll(player)
                                    player.knife.spawned = true
                                end
                            else
                                player.knife.spawned = false
                            end
                    
                            local param2 = player.knife:GetGraphParameter("weapon_fire_secondary_autoclear")
                            if param2 == true then
                                    
                                if not player.knife.spawned2 then
                                    ExpTrace(player)

                                    player.knife.spawned2 = true
                                end
                            else
                                player.knife.spawned2 = false
                            end
                        end
                        
                    
                    end
                    if player == GetListenServerHost() then
                        player:SetMaxHealth(1000)
                        player:SetHealth(1000)
                    end
    
                    return FrameTime()
                end,"KNIFE",0)
                
            end
        end
end


